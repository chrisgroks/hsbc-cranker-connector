name: Snyk Security Scan

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

permissions:
  contents: read
  security-events: write  # For uploading SARIF results to GitHub Security tab

jobs:
  snyk:
    name: Snyk Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build project (required for Snyk to analyze dependencies)
        run: mvn --batch-mode install -DskipTests
      
      - name: Install Snyk CLI
        run: npm install -g snyk
      
      - name: Run Snyk to check for vulnerabilities
        continue-on-error: false  # Fail the build on high+ severity vulnerabilities
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}  # Add this secret in GitHub repo settings
        run: |
          snyk test --maven --severity-threshold=high --sarif-file-output=snyk.sarif || true
          # Allow to continue to upload results even if vulnerabilities found
      
      - name: Upload Snyk results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()  # Upload even if previous step fails to see what was found
        with:
          sarif_file: snyk.sarif
      
      - name: Run Snyk Code (SAST)
        continue-on-error: true  # Code analysis might not find issues
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk code test --severity-threshold=high || echo "Snyk Code scan completed"
